@model IEnumerable<Hotel>

@inject IHttpContextAccessor HttpContextAccessor
@{
	ViewData["Title"] = "Hotels";
}

<div class="d-flex justify-content-center center-div flex-wrap border-0 p-0">
	<form class="col-md-4 filter-div bg-light">
		@*<div class="form-group">
			<select name="currency" asp-items="Html.GetEnumSelectList<Currency>()" class="form-select">
			</select>
		</div>*@
		<h4>Sort by</h4>
		<h6>Price</h6>
		<div class="form-group">
			<select name="sort" asp-items="Html.GetEnumSelectList<Sort>()" class="form-select">
			</select>
		</div>
		<h4>Filter by</h4>
		<h6>Price range</h6>
		<div class="d-flex inline-block">
			<div class="form-group w-100">
				<input type="number" name="minprice" class="form-control" id="minprice" placeholder="Minimum price">
			</div>
			<div class="form-group w-100">
				<input type="number" name="maxprice" class="form-control" id="maxprice" placeholder="Maximum price">
			</div>
		</div>
		<div class="form-group">
		</div>
		<div class="btn-group col-12 mt-4">
			<button type="submit" value="submit" id="filter-submit" formaction="/Hotel/Index?currency=USD&multiplier=1.00" name="submit" formmethod="post" class="btn btn-outline-primary">
				<i class="bi bi-funnel"></i>
				Apply filters
			</button>
			<a class="btn btn-outline-danger" asp-controller="Hotel" asp-action="ResetIndex">
				<i class="bi bi-x"></i>
				Reset filters
			</a>
		</div>

		<hr class="my-4"/>

		<div class="news-div bg-white">
		
		<img id="news-image" src="" class="w-100"/>
		<div class="m-2 lh-sm "><h5><a class="text-decoration-none text-dark" id="news-title" href="" target="blank"></a></h5></div>
		<div class="m-2 lh-1 nonaccent" id="news-description"></div>
		<div class="d-flex justify-content-around">
			<h5 id="left-btn" class="m-0 border-top rounded-bl news-button bi bi-arrow-left-circle col-md-6"></h5>
			<h5 id="right-btn" class="m-0 border-top rounded-br news-button bi bi-arrow-right-circle col-md-6"></h5>
		</div>
		</div>


	</form>
	<div class="col-md-8 result-div">
		@if (Model.Count() == 0)
		{
			<div class="text-danger">There are no such hotels. Please try searching again!</div>
		}
		@foreach (var hotel in Model)
		{
			<div class="infocard">
				<div class="infocard-container col-md-4">
					<img src="img/hotel/hotel1.jpg" class="infocard-img" alt="">
				</div>
				<div class="infocard-body col-md">
					<h4>@Html.DisplayFor(hotelItem => hotel.Name)</h4>
					<p id="city" class="nonaccent">@Html.DisplayFor(hotelItem => hotel.City)</p>
					<p class="nonaccent">@Html.DisplayFor(hotelItem => hotel.Address)</p>
					<div class="price price position-absolute bottom-10 start-10 price-item">USD @Html.DisplayFor(hotelItem => hotel.Price).00</div>
					<div class="position-absolute bottom-10 end-10">
						<a asp-action="BookHotel" asp-controller="Hotel" asp-route-id=@hotel.HotelId type="submit" class="btn btn-outline-primary">
							<i class="bi bi-bookmark-check"></i> Book room
						</a>
					</div>
					<div class="position-absolute top-10 end-10">
						<a asp-action="Review" asp-controller="Hotel" title="Leave a review" asp-route-id=@hotel.HotelId type="submit" class="btn btn-outline-success">
							<i class="bi bi-chat-left"></i>
						</a>
					</div>
				</div>
			</div>
		}

	</div>
</div>


<script>
	
	var news;
	var newsIndex = 0;
	var city = document.getElementById("city").textContent.toLowerCase();
	// Specify the URL of the API you want to fetch data from
	const url = 'https://newsapi.org/v2/everything?q='+city+'+travel&apiKey=2c04979a7936442883e7ba181bf937b7&language=en';

	// Use the fetch function to make a GET request to the specified URL
	fetch(url)
	  .then(response => {
		// Check if the request was successful (status code 200-299)
		if (!response.ok) {
		  throw new Error(`Network response was not ok: ${response.statusText}`);
		}
    
		// Parse the JSON response
		return response.json();
	  })
	  .then(data => {
		// Handle the data
		var unmappedData = data.articles.slice(0,3);
		news = unmappedData.map(item => {
			return {
				title: item.title,
				description: item.description,
				url: item.url,
				image: item.urlToImage
			}
		})
		changeNews()
	  })
	  .catch(error => {
		// Handle errors
		console.error('Error fetching data:', error);
	  });

	  document.getElementById("left-btn").addEventListener("click", function(){
		  changeNews("-")
	  })
	  document.getElementById("right-btn").addEventListener("click", function(){
		  changeNews("+")
	  })

	  function changeNews(op){
		  switch(op){
			  case "+":
					newsIndex = newsIndex >= news.length - 1 ? 0 : newsIndex+1;
					break;
			  case "-":
					newsIndex = newsIndex <= 0 ? news.length - 1 : newsIndex-1;
					break;
		  }

		  document.getElementById("news-image").setAttribute("src", news[newsIndex].image);
		  document.getElementById("news-title").textContent = news[newsIndex].title;
		  document.getElementById("news-title").setAttribute("href", news[newsIndex].url);
		  document.getElementById("news-description").textContent = news[newsIndex].description;
		  
		  
	  }

</script>



<script>
	document.getElementById("exchange").classList.remove("d-none");

	var pastCurrency = '@HttpContextAccessor.HttpContext.Session.GetString("currency")';
	var pastMultiplier = '@HttpContextAccessor.HttpContext.Session.GetString("multiplier")';
	console.log("+++",pastCurrency, pastMultiplier);
	var filterBtn = document.getElementById("filter-submit");
	var currencyDropdown = document.getElementById("currency-dropdown");

	if(pastCurrency != ""){
		changePrices(pastCurrency, pastMultiplier);
		changeFilterButton(pastCurrency, pastMultiplier);
	}
	
	var currentCurrency = pastCurrency == "" ? "USD" : pastCurrency;
	currencyDropdown.textContent = pastCurrency == "" ? "USD" : pastCurrency;
	console.log(">>>", currentCurrency)
	document.getElementById("currency-selection").addEventListener("click", function(event) {
		if (event.target.classList.contains("currency-select")) {

			var currency = event.target.getAttribute("name");
			var apiUrl = 'https://openexchangerates.org/api/latest.json?app_id=8c6c1dacc56f41b0a813bb5fae8205e0&symbols='+currency+','+currentCurrency;
			fetch(apiUrl)
				.then(response => {
				if (!response.ok) {
					throw new Error("Network response was not ok");
				}
				return response.json();
				})
				.then(data => {

					console.log(currentCurrency, "--->", currency)

					currencyDropdown.textContent = currency;

				var currentMultiplier = parseFloat(data['rates'][currentCurrency]).toFixed(2);
				var upcomingMultiplier = parseFloat(data['rates'][currency]).toFixed(2);
				var multiplier = upcomingMultiplier/currentMultiplier;
				currentCurrency = currency;

				changePrices(currency, multiplier);

				changeFilterButton(currency, upcomingMultiplier);

				})
				.catch(error => {
				console.error("Error fetching data:", error);
				});
		}	
	})

	function changePrices(currency, multiplier){
		var priceItems = document.getElementsByClassName("price-item");
		for (var i = 0; i < priceItems.length; i++) {
			var currentItem = priceItems[i].textContent;
			currentItem = currentItem.split(" ");
			currentItem[0] = currency;
			currentItem[1] = Number(parseFloat(currentItem[1]) * multiplier).toFixed(2);
			priceItems[i].textContent = currentItem.join(" ");
		}
	}

	function changeFilterButton(currency, multiplier){
		var formactionString = filterBtn.getAttribute("formaction");
		formactionString = formactionString.split("?");
		formactionString[1] = 'currency='+currency+'&multiplier='+multiplier;
		formactionString = formactionString.join("?");
		filterBtn.setAttribute("formaction", formactionString);
	}

	// Iterate over all elements
	
</script>
